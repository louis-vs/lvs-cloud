#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_key}
      - ${github_actions_ssh_key}

package_update: true
packages:
  - docker.io
  - docker-compose-v2
  - curl
  - wget
  - git
  - htop
  - apache2-utils # for htpasswd

write_files:
  - path: /etc/docker/daemon.json
    owner: root:root
    permissions: '0644'
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "metrics-addr": "0.0.0.0:9323",
        "experimental": true
      }

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu

  # Wait for volume to be attached and create mount point
  - sleep 10
  - mkdir -p /mnt/data

  # Find and mount the volume (Hetzner volumes appear as /dev/sdb typically)
  - |
    for i in {1..30}; do
      if [ -e /dev/sdb ]; then
        echo "Volume found at /dev/sdb"
        break
      fi
      echo "Waiting for volume... ($i/30)"
      sleep 2
    done

  # Check if volume is already formatted, if not format it
  - |
    if ! blkid /dev/sdb; then
      echo "Formatting volume with ext4"
      mkfs.ext4 /dev/sdb
    fi

  # Mount the volume
  - mount /dev/sdb /mnt/data

  # Add to fstab for persistent mounting
  - echo '/dev/sdb /mnt/data ext4 defaults 0 2' >> /etc/fstab

  # Create directory structure (GitOps workflows will handle configs)
  - mkdir -p /opt/monitoring-stack
  - mkdir -p /opt/traefik
  - mkdir -p /opt/apps
  - mkdir -p /etc/traefik

  # Create persistent data directories with correct permissions
  - mkdir -p /mnt/data/grafana /mnt/data/prometheus /mnt/data/loki /mnt/data/registry /mnt/data/mimir /mnt/data/tempo
  - chown -R 472:472 /mnt/data/grafana
  - chown -R 65534:65534 /mnt/data/prometheus
  - chown -R 10001:10001 /mnt/data/loki
  - chown -R 1000:1000 /mnt/data/registry
  - chown -R 10001:10001 /mnt/data/mimir
  - chown -R 10001:10001 /mnt/data/tempo

  # Set permissions for other directories
  - chown -R ubuntu:ubuntu /opt/monitoring-stack
  - chown -R ubuntu:ubuntu /opt/traefik
  - chown -R ubuntu:ubuntu /opt/apps

  # Create Traefik configuration and ACME file
  - |
    cat > /etc/traefik/traefik.yml << 'TRAEFIKEOF'
    api:
      dashboard: true
      insecure: false

    entryPoints:
      web:
        address: ":80"
        http:
          redirections:
            entrypoint:
              to: websecure
              scheme: https
              permanent: true

      websecure:
        address: ":443"

    providers:
      docker:
        endpoint: "unix:///var/run/docker.sock"
        exposedByDefault: false
        network: web

    certificatesResolvers:
      letsencrypt:
        acme:
          email: louis@lvs.me.uk
          storage: /etc/traefik/acme.json
          httpChallenge:
            entryPoint: web

    log:
      level: INFO

    accessLog: {}
    TRAEFIKEOF

  - touch /etc/traefik/acme.json
  - chmod 600 /etc/traefik/acme.json

  # Note: All service configurations will be deployed via GitOps workflows

  # Restart docker to apply daemon.json changes
  - systemctl restart docker

  # Wait for docker to be ready
  - sleep 10

  # Create networks
  - docker network create web 2>/dev/null || true
  # Note: monitoring network will be created by docker-compose when services start

  # Start Traefik (must be started first)
  - cd /opt/traefik && docker compose up -d


  - echo "Server setup complete - ready for GitOps deployment" > /var/log/setup.log
