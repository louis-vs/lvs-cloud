#cloud-config

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_key}

package_update: true
packages:
  - curl
  - wget
  - git
  - htop

write_files:
  # k3s registry authentication
  - path: /etc/rancher/k3s/registries.yaml
    owner: root:root
    permissions: '0644'
    content: |
      mirrors:
        "registry.lvs.me.uk":
          endpoint:
            - "https://registry.lvs.me.uk"
      configs:
        "registry.lvs.me.uk":
          auth:
            username: robot_user
            password: "${registry_pass}"

  # Weekly k3s upgrade script
  - path: /usr/local/sbin/k3s-upgrade.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      NODE="$(hostname)"
      kubectl cordon "$NODE" || true

      INSTALL_K3S_CHANNEL="stable" \
      INSTALL_K3S_FORCE_RESTART="true" \
      curl -sfL https://get.k3s.io | sh -s - server \
        --write-kubeconfig-mode 644 \
        --data-dir /srv/data/k3s

      sleep 10
      kubectl uncordon "$NODE" || true

  # Weekly k3s upgrade systemd service
  - path: /etc/systemd/system/k3s-upgrade.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=Weekly k3s upgrade

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/k3s-upgrade.sh

  # Weekly k3s upgrade systemd timer
  - path: /etc/systemd/system/k3s-upgrade.timer
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=Run k3s-upgrade weekly (Sun 03:00)

      [Timer]
      OnCalendar=Sun *-*-* 03:00:00
      Persistent=true

      [Install]
      WantedBy=timers.target


runcmd:
  # Prevent locale issues
  - locale-gen --keep-existing en_GB.UTF-8

  # Configure 12GB swap file (1.5x RAM for 8GB server)
  - |
    fallocate -l 12G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab

  # Wait for volume to be attached
  - sleep 10
  - mkdir -p /srv/data

  # Mount volume
  - |
    for i in {1..30}; do
      if [ -e /dev/sdb ]; then
        echo "Volume found at /dev/sdb"
        break
      fi
      echo "Waiting for volume... ($i/30)"
      sleep 2
    done

  # Format volume if needed
  - |
    if ! blkid /dev/sdb; then
      echo "Formatting volume with ext4"
      mkfs.ext4 /dev/sdb
    fi

  # Mount volume
  - mount /dev/sdb /srv/data
  - echo '/dev/sdb /srv/data ext4 defaults 0 2' >> /etc/fstab

  # Create data directories
  - mkdir -p /srv/data/longhorn
  - mkdir -p /srv/data/k3s
  - chown -R root:root /srv/data

  # Install k3s (with Traefik for ingress)
  - |
    curl -sfL https://get.k3s.io | sh -s - \
      --write-kubeconfig-mode 644 \
      --data-dir /srv/data/k3s

  # Wait for k3s to be ready
  - sleep 30
  - kubectl wait --for=condition=ready node --all --timeout=300s

  # Enable weekly k3s upgrades
  - systemctl enable k3s-upgrade.timer

  # Configure kubectl for ubuntu user
  - echo 'export KUBECONFIG=/etc/rancher/k3s/k3s.yaml' >> /home/ubuntu/.bashrc
  - chown ubuntu:ubuntu /home/ubuntu/.bashrc

  # Setup complete (manual bootstrap still required)
  - echo "K3s setup complete" > /var/log/lvs-cloud-setup.log
  - echo "SSH to server and follow docs/BOOTSTRAP.md" >> /var/log/lvs-cloud-setup.log
  - date >> /var/log/lvs-cloud-setup.log
