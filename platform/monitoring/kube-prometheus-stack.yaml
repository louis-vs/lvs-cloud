---
# grafana-admin secret created by infrastructure/bootstrap/bootstrap.sh
# See SECRETS.md for complete secret inventory
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: platform
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: ">=68.0.0"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  values:
    # Prometheus configuration
    prometheus:
      prometheusSpec:
        retention: 3d
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 512Mi
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 8Gi
              metadata:
                annotations:
                  longhorn.io/recurring-jobs: |
                    [
                      {"name":"daily-snap","task":"snapshot","cron":"0 2 * * *","retain":7,"concurrency":1,"labels":{"app":"prometheus"}},
                      {"name":"weekly-bak","task":"backup","cron":"0 3 * * 0","retain":4,"concurrency":1,"labels":{"app":"prometheus"}}
                    ]

    # Disable default alert rules (use only custom rules in alert-rules.yaml)
    defaultRules:
      create: false

    # Alertmanager configuration
    alertmanager:
      alertmanagerSpec:
        # External URL for alert links
        externalUrl: https://alertmanager.lvs.me.uk

        # Enable AlertmanagerConfig CRD support
        alertmanagerConfigSelector:
          matchLabels:
            alertmanagerConfig: email
        alertmanagerConfigNamespaceSelector: {}

        resources:
          requests:
            cpu: 10m
            memory: 50Mi
          limits:
            cpu: 50m
            memory: 128Mi
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 1Gi

    # Grafana configuration
    grafana:
      enabled: true

      admin:
        existingSecret: grafana-admin
        userKey: admin-user
        passwordKey: admin-password

      env:
        GF_SERVER_ROOT_URL: "https://grafana.lvs.me.uk"
        GF_USERS_ALLOW_SIGN_UP: "false"

        # Authelia OIDC authentication
        GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
        GF_AUTH_GENERIC_OAUTH_NAME: "Authelia"
        GF_AUTH_GENERIC_OAUTH_CLIENT_ID: "grafana"
        GF_AUTH_GENERIC_OAUTH_SCOPES: "openid profile email groups"
        GF_AUTH_GENERIC_OAUTH_AUTH_URL: "https://auth.lvs.me.uk/api/oidc/authorization"
        GF_AUTH_GENERIC_OAUTH_TOKEN_URL: "https://auth.lvs.me.uk/api/oidc/token"
        GF_AUTH_GENERIC_OAUTH_API_URL: "https://auth.lvs.me.uk/api/oidc/userinfo"
        GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH: "sub"
        GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH: "groups"
        GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH: "name"
        GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH: "email"
        GF_AUTH_GENERIC_OAUTH_USE_PKCE: "true"
        GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH: "contains(groups[*], 'admins') && 'Admin' || 'Viewer'"
        GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP: "true"
        GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN: "false"
        GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: "$__file{/etc/secrets/oauth-client-secret}"

      extraSecretMounts:
        - name: oauth-secret
          secretName: grafana-oauth
          defaultMode: 0440
          mountPath: /etc/secrets
          readOnly: true

      persistence:
        enabled: true
        storageClassName: longhorn
        size: 1Gi
        annotations:
          longhorn.io/recurring-jobs: |
            [
              {"name":"daily-snap","task":"snapshot","cron":"0 2 * * *","retain":7,"concurrency":1,"labels":{"app":"grafana"}},
              {"name":"weekly-bak","task":"backup","cron":"0 3 * * 0","retain":4,"concurrency":1,"labels":{"app":"grafana"}}
            ]

      # Enable dashboard sidecar to provision default dashboards
      sidecar:
        dashboards:
          enabled: true
          searchNamespace: ALL
        datasources:
          enabled: false

      resources:
        requests:
          cpu: 50m
          memory: 32Mi
        limits:
          cpu: 150m
          memory: 256Mi

      ingress:
        enabled: true
        ingressClassName: traefik
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
        hosts:
          - grafana.lvs.me.uk
        path: /
        pathType: Prefix
        tls:
          - secretName: grafana-tls
            hosts:
              - grafana.lvs.me.uk

      # Configure datasources
      datasources:
        datasources.yaml:
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://kube-prometheus-stack-prometheus.platform.svc.cluster.local:9090
              editable: true
              isDefault: true
            - name: Loki
              type: loki
              access: proxy
              url: http://loki.platform.svc.cluster.local:3100
              editable: true
              isDefault: false

    # Node Exporter configuration
    nodeExporter:
      enabled: true

    prometheus-node-exporter:
      resources:
        requests:
          cpu: 10m
          memory: 30Mi
        limits:
          cpu: 50m
          memory: 64Mi

    # Kube State Metrics
    kube-state-metrics:
      resources:
        requests:
          cpu: 20m
          memory: 40Mi
        limits:
          cpu: 50m
          memory: 96Mi

    # Prometheus Operator
    prometheusOperator:
      resources:
        requests:
          cpu: 20m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi
