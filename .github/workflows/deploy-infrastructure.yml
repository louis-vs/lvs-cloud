name: Deploy Infrastructure

on:
  push:
    branches: [master]
    paths:
      - 'infrastructure/**'
      - 'platform/monitoring/**'
      - 'platform/registry/**'
      - 'platform/traefik/**'
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  TF_VAR_project_name: 'lvs-cloud'
  TF_VAR_domain: 'lvs.me.uk'
  TF_VAR_registry_user: ${{ secrets.REGISTRY_USERNAME }}
  TF_VAR_registry_pass: ${{ secrets.REGISTRY_PASSWORD }}
  # AWS credentials for S3 backend (Hetzner Object Storage)
  AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}

# Token Strategy:
# - HCLOUD_TOKEN_RO: Read-only operations (fmt, init, validate, outputs)
# - HCLOUD_TOKEN_RW: Read-write operations (plan, apply)

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    outputs:
      server_ip: ${{ steps.terraform-output.outputs.server_ip }}

    defaults:
      run:
        working-directory: infrastructure

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      AWS_EC2_METADATA_DISABLED: true
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'

      - name: Terraform Format
        run: terraform fmt -check
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RO }}

      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RO }}

      - name: Terraform Validate
        run: terraform validate
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RO }}

      - name: Terraform Plan
        id: plan
        run: |
          set +e  # Don't exit on error for this step
          echo "ðŸ”„ Running terraform plan..."
          terraform plan -input=false -out=tfplan -detailed-exitcode
          PLAN_EXIT_CODE=$?
          echo "ðŸ“Š Terraform plan exit code: $PLAN_EXIT_CODE"
          echo "exitcode=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT

          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [ $PLAN_EXIT_CODE -eq 1 ]; then
            echo "âŒ Terraform plan failed with an error"
            exit 1
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "âš ï¸  Infrastructure changes detected - approval required"
            exit 0
          else
            echo "âœ… No infrastructure changes detected (exit code: $PLAN_EXIT_CODE)"
            exit 0
          fi
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RW }}

      - name: Show Plan Summary
        run: terraform show tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RO }}

      - name: Request Approval for Infrastructure Changes
        if: steps.plan.outputs.exitcode == '2'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: 'Infrastructure Deployment Approval Required'
          issue-body: |
            **Infrastructure changes detected!**

            Terraform plan shows changes will be made to the infrastructure.

            **Review the plan output above** and approve this deployment to proceed.

            - **Branch**: `${{ github.ref_name }}`
            - **Commit**: `${{ github.sha }}`
            - **Triggered by**: ${{ github.event_name }}

      - name: Terraform Apply
        if: github.ref == 'refs/heads/master' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (steps.plan.outputs.exitcode == '0' || steps.plan.outputs.exitcode == '2')
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RW }}

      - name: Get Terraform Outputs
        id: terraform-output
        run: |
          echo "server_ip=$(terraform output -raw server_ip)" >> $GITHUB_OUTPUT
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN_RO }}

  deploy-traefik:
    name: 'Deploy Shared Traefik'
    runs-on: ubuntu-latest
    needs: terraform
    if: github.ref == 'refs/heads/master' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && !cancelled() && !failure()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy shared Traefik configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.terraform.outputs.server_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error

            # Wait for cloud-init to complete
            echo "â³ Waiting for system setup to complete..."
            sudo cloud-init status --wait || {
              echo "âŒ Cloud-init failed or timed out"
              exit 1
            }

            # Verify Docker is available
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not available"
              exit 1
            fi

            # Create directories if they don't exist
            sudo mkdir -p /opt/traefik
            sudo mkdir -p /etc/traefik
            sudo chown ubuntu:ubuntu /opt/traefik

            # Update shared Traefik
            cd /opt/traefik

            # Download latest traefik configuration files
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o docker-compose.yml \
                 https://api.github.com/repos/${{ github.repository }}/contents/platform/traefik/docker-compose.yml

            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o /tmp/traefik.yml \
                 https://api.github.com/repos/${{ github.repository }}/contents/platform/traefik/traefik.yml

            # Update Traefik static configuration
            sudo cp /tmp/traefik.yml /etc/traefik/traefik.yml

            # Restart Traefik (must be done first before other services)
            sudo docker compose up -d --remove-orphans

            echo "âœ… Shared Traefik updated successfully"

  deploy-registry:
    name: 'Deploy Registry'
    runs-on: ubuntu-latest
    needs: [terraform, deploy-traefik]
    if: github.ref == 'refs/heads/master' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy registry
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.terraform.outputs.server_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error

            # Verify prerequisites are met
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not available"
              exit 1
            fi

            # Create directories if they don't exist
            sudo mkdir -p /opt/registry
            sudo chown ubuntu:ubuntu /opt/registry

            # Update registry
            cd /opt/registry

            # Download latest docker-compose file
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o docker-compose.yml \
                 https://api.github.com/repos/${{ github.repository }}/contents/platform/registry/docker-compose.yml

            # Start registry service
            sudo docker compose up -d --remove-orphans

            echo "âœ… Registry deployed successfully"

  deploy-stack:
    name: 'Deploy Monitoring Stack'
    runs-on: ubuntu-latest
    needs: [terraform, deploy-traefik]
    if: github.ref == 'refs/heads/master' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy monitoring stack
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.terraform.outputs.server_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error

            # Verify prerequisites are met
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not available"
              exit 1
            fi

            # Create directories if they don't exist
            sudo mkdir -p /opt/monitoring-stack
            sudo chown ubuntu:ubuntu /opt/monitoring-stack

            # Update monitoring stack
            cd /opt/monitoring-stack

            # Create environment file with secure credentials
            cat > .env << 'EOF'
            # Grafana Configuration
            GRAFANA_ADMIN_USER=admin
            GRAFANA_ADMIN_PASS=${{ secrets.GRAFANA_ADMIN_PASS }}

            # Registry Configuration
            REGISTRY_USER=${{ secrets.REGISTRY_USERNAME }}
            REGISTRY_PASS=${{ secrets.REGISTRY_PASSWORD }}
            EOF

            # Download latest docker-compose file
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o docker-compose.yml \
                 https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/docker-compose.prod.yml

            # Create all config directories
            mkdir -p grafana/provisioning/{dashboards,datasources}
            mkdir -p loki

            # Download all monitoring configuration files
            echo "ðŸ“¥ Downloading monitoring configuration files..."

            # Prometheus config
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o prometheus.yml \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/prometheus.yml"

            # Loki config
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o loki/local-config.yaml \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/loki/local-config.yaml"

            # Grafana datasources
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o grafana/provisioning/datasources/prometheus.yml \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/grafana/provisioning/datasources/prometheus.yml"

            # Grafana dashboards config
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o grafana/provisioning/dashboards/dashboards.yml \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/grafana/provisioning/dashboards/dashboards.yml"

            # Grafana dashboard files
            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o grafana/provisioning/dashboards/system-overview.json \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/grafana/provisioning/dashboards/system-overview.json"

            curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o grafana/provisioning/dashboards/application-metrics.json \
                 "https://api.github.com/repos/${{ github.repository }}/contents/platform/monitoring/grafana/provisioning/dashboards/application-metrics.json"

            echo "âœ… All configuration files downloaded"

            # Stop existing services first to avoid conflicts
            sudo docker compose down 2>/dev/null || true

            # Remove potentially conflicting networks (they'll be recreated correctly)
            sudo docker network rm monitoring 2>/dev/null || true

            # Start services with environment variables (Traefik is already running)
            sudo docker compose up -d --remove-orphans

            echo "âœ… Monitoring stack updated successfully"

  # NOTE: Application deployment is now handled by deploy-applications.yml workflow
  # This ensures applications deploy automatically on ANY file changes, not just compose changes
