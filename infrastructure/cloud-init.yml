#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_key}
      - ${github_actions_ssh_key}

package_update: true
packages:
  - docker.io
  - docker-compose-v2
  - curl
  - wget
  - git
  - htop
  - apache2-utils # for htpasswd

write_files:
  - path: /etc/docker/daemon.json
    owner: root:root
    permissions: '0644'
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "metrics-addr": "0.0.0.0:9323",
        "experimental": true
      }

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu

  # Create directory structure (GitOps workflows will handle configs)
  - mkdir -p /opt/monitoring-stack
  - mkdir -p /opt/traefik
  - mkdir -p /opt/apps
  - mkdir -p /var/lib/grafana
  - mkdir -p /var/lib/prometheus
  - mkdir -p /var/lib/loki
  - mkdir -p /var/lib/registry
  - mkdir -p /etc/traefik

  # Set permissions for directories
  - chown -R ubuntu:ubuntu /opt/monitoring-stack
  - chown -R ubuntu:ubuntu /opt/traefik
  - chown -R ubuntu:ubuntu /opt/apps

  # Set container-specific permissions for data directories
  - chown -R 472:472 /var/lib/grafana || true
  - chown -R 65534:65534 /var/lib/prometheus || true
  - chown -R 10001:10001 /var/lib/loki || true
  - chown -R 10001:10001 /loki || true

  # Create Traefik configuration and ACME file
  - |
    cat > /etc/traefik/traefik.yml << 'TRAEFIKEOF'
    api:
      dashboard: true
      insecure: false

    entryPoints:
      web:
        address: ":80"
        http:
          redirections:
            entrypoint:
              to: websecure
              scheme: https
              permanent: true

      websecure:
        address: ":443"

    providers:
      docker:
        endpoint: "unix:///var/run/docker.sock"
        exposedByDefault: false
        network: web

    certificatesResolvers:
      letsencrypt:
        acme:
          email: louis@lvs.me.uk
          storage: /etc/traefik/acme.json
          httpChallenge:
            entryPoint: web

    log:
      level: INFO

    accessLog: {}
    TRAEFIKEOF

  - touch /etc/traefik/acme.json
  - chmod 600 /etc/traefik/acme.json

  # Note: All service configurations will be deployed via GitOps workflows

  # Restart docker to apply daemon.json changes
  - systemctl restart docker

  # Wait for docker to be ready
  - sleep 10

  # Create networks
  - docker network create web 2>/dev/null || true
  # Note: monitoring network will be created by docker-compose when services start

  # Start Traefik (must be started first)
  - cd /opt/traefik && docker compose up -d

  # Create Loki data directories (needed by container)
  - mkdir -p /loki/{chunks,boltdb-shipper-active,boltdb-shipper-cache,rules,rules-temp}
  - chown -R 10001:10001 /loki

  - echo "Server setup complete - ready for GitOps deployment" > /var/log/setup.log
